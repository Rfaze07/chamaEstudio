{% extends '../../template.html' %}

{% block styles %} 
    <style type="text/css">

    </style>
{% endblock %}

{% block content %}
    <div class="row">
        <div class="col-12 mb-4">
            <h4 id="title"><i class="fa fa-users"></i>&nbsp;{{ pagename }}</h4>
        </div>
        <div class="col-md-4">
            <div class="form-group">
                <label for="empleado"><b>Empleado</b></label>
                <select id="empleado"class="form-control" onchange="GeneroUserPass(this.value)"></select>
            </div>
        </div>
        <div class="col-md-4">
            <div class="form-group">
                <label for="usuario"><b>Nombre de usuario</b></label>
                <input class="form-control" id="usuario" placeholder="Nombre de usuario" required maxlength="20" autocomplete="off">
            </div>
        </div>
        <div class="col-md-4">
            <div class="form-group">
                <label for="mail"><b>Mail</b></label>
                <input class="form-control" maxlength="50" id="mail" placeholder="ejemplo@hotmail.com" autocomplete="off">
            </div>
        </div>
        <div class="col-md-6">
            <div class="form-group">
                <label for="clave"><b>Clave</b></label>
                <input class="form-control" type="password" id="clave" placeholder="Introduzca una clave de al menos 6 caracteres" required maxlength="20" minlength="6" autocomplete="new-password">
            </div>
        </div>
        <div class="col-md-6" id="divNiveles">
            <div class="form-group">
                <label for="clave"><b>Niveles</b></label>
                <select id="niveles"class="form-control">
                    {% if nivel.indexOf('Administrador') > -1 || nivel.indexOf('Developer') > -1 %}
                        <option selected value="Administrador">Administrador</option>
                    {% endif %}
                    <option value="Lista">Lista</option>
                </select>
            </div>
        </div>
        <div class="col-12">
            <div class="form-group" style="float: right;">
                <button id="Guardar" onclick="Alta()" class="btn btn-round btn-success"><i class="fa fa-save"></i>&nbsp;Guardar</button>
                <a href="/usuarios" class="btn btn-round btn-danger"><i class="fa fa-arrow-left"></i>&nbsp;Volver</a>
            </div>
        </div>
    </div>
{% endblock %}
{% block scripts%}
<script>

    const Alta = async () => {
        $("#preloader").show();
        
        let body = {
            usuario: $("#usuario").val(),
            mail: $("#mail").val(),
            clave: $("#clave").val(),
            niveles: $("#niveles").val(),
            empleado: $("#empleado").val()
        }
        const res = await $.post("/usuarios/alta", body);
        $("#preloader").hide();
        Swal.fire({
            icon: res.type,
            title: res.title,
            text: res.text,
            timer: 2500
        }).then(() => {
            if (res.type == "success") window.location = "/usuarios";
        });
    }

    const ObtenerEmpleados = async () => {
        let html='<option value="" selected>No es empleado</option>',
            res = await $.post('/empleados/listaAjax', {activo:1})

        if(res.status){
            res.data.map(el => html += `<option value="${el.id}">${el.nro_legajo} - ${el.nombre} ${el.apellido}</option>`)
        }
        $('#empleado').html(html)
    }
    ObtenerEmpleados()

    const GeneroUserPass = async id => {
        if(id.length == 0){
            $('#divNiveles').removeClass('d-none')
            $('#usuario').val('')
            $('#clave').val('')
            $('#mail').val('')
        }else{
            let res = await $.post('/usuarios/generoUserPass', {id})
            if(res.status){
                $('#divNiveles').addClass('d-none')
                $('#usuario').val(res.user)
                $('#clave').val(res.pass)
                $('#mail').val(res.email)
            }
        }
    }

</script>
{% endblock %}