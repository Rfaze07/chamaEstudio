require("dotenv").config();
const express = require("express");
const app = express();
const cons = require("consolidate");
require("swig");
const redis = require("redis");
const session = require("express-session");
let RedisStore = require("connect-redis").default;
let redisClient = redis.createClient({url : 'redis://127.0.0.1:6379'});
const compression = require("compression");
const port = process.env.PORT || 3000;
const menues = require("./menu");
const db = require("./database");



app.use(compression());
app.use(express.urlencoded({ extended: true }));
app.use(express.json());
app.use(
  session({
    name: "sessionCookie$Tp#-agG3eTg7GP0Nq",
    secret: process.env.SECRETKEY,
    store: new RedisStore({ client: redisClient }),
    resave: false,
    saveUninitialized: false
  })
);

app.use(function (req, res, next) {
  res.locals.session = req.session;
  next();
});

app.engine("html", cons.swig);
app.set("view engine", "html");
app.set("views", __dirname + "/modules");
app.use(express.static(__dirname + "/public"));

app.use(async function (req, res, next) {
  if (req.session.user != null) {
    res.locals.user = req.session.user;
  }
  res.locals.menu = await menues.getMenuHTML();
  next();
});

// app.use(require("./modules/backup/routes"));
app.use(require("./modules/programador/routes"));
app.use(require("./modules/index/routes"));
app.use(require("./modules/usuarios/routes"));
app.use(require("./modules/categorias/routes"));
app.use(require("./modules/subCategorias/routes"));
app.use(require("./modules/clientes/routes"));
app.use(require("./modules/tiposDocumentosAfip/routes"));

app.use(require("./modules/provincias/routes"));
app.use(require("./modules/localidades/routes"));





app.use(require("./modules/equipos/routes"));
app.use(require("./modules/jugadores/routes"));
app.use(require("./modules/partidos/routes"));
app.use(require("./modules/noticias/routes"));


app.use(require("./modules/web/index/routes"));
app.use(require("./modules/web/equipos/routes"));
app.use(require("./modules/web/partidos/routes"));
app.use(require("./modules/web/noticias/routes"));
app.use(require("./modules/web/lideres/routes"));/*aca */



(async function () {
  try {
    await redisClient.connect();
    console.log("Redis iniciado...");
    await db.initConnectionMYSQL();
    console.log("ConexiÃ³n a MySQL establecida...");
    app.listen(port, async (error) => {
      if (error) throw error;
      console.log(`Escuchando en el puerto ${port}`);
    });
  } catch (er) {
    console.error(er);
    process.exit();
  }
})();